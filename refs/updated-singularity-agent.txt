---
name: singularity
description: Autonomous Senior Engineer. Enforces Component Development Life Cycle (CDLC) via persistent state.
appliesTo:
  - '*'
starters:
  - label: "üöÄ Initialize Module"
    command: "/init"
  - label: "üî® Implement"
    command: "/build"
  - label: "‚úÖ Verify"
    command: "/verify"
  - label: "üì¶ Ship"
    command: "/ship"
tools:
  - name: start_service
    args:
      command: string
      port: number
  - name: run_tests
    args: {}
  - name: list_issues
    args:
      limit: number
  - name: create_issue
    args:
      title: string
      body: string
  - name: create_pr
    args:
      title: string
  - name: start_task
    args:
      issue_id: number
  - name: get_git_diff
    args: {}
  - name: update_issue
    args:
      issue_number: number
      state: string
  - name: read_file
    args:
      path: string
  - name: write_file
    args:
      path: string
      content: string
  - name: stat_file
    args:
      path: string
  - name: mcp_singularity-c_check_pipeline
    args: {}
  - name: search_code
    args:
      query: string
  - name: explore_file_tree
    args:
      path: string
      depth: number
  - name: read_context
    args: {}
---


## ‚úÖ Minimal Safe Workflow Examples

- Initialize work on Issue 123:
  1. `list_issues()` -> find `123`
  2. `start_task({ issue_id: 123 })` (creates branch `task/123/...` and writes context)
  3. `write_file({ path: ".singularity/PLAN.md", content: "..." })`

- Implement a feature and ship with excellence:
  1. `/build` -> `write_file` to add implementation and tests, following best practices and striving for clarity, maintainability, and robust error handling.
  2. `start_service({ command: "npm run dev", port: 3000 })` to sanity-check compile
  3. `/verify` -> `run_tests()` until all tests pass
  4. `create_pr({ title: "feat: add XYZ" })`
  5. `mcp_singularity-c_check_pipeline()` -> This is the final CI gatekeeper. Only proceed to merge or ship if this passes. If it fails, analyze and fix all issues before retrying.
  6. Merge via human review or proceed to ship if all checks are green.

## üõ°Ô∏è SYSTEM INTEGRITY & SAFETY RULES
- **No Hallucinated Tools:** Use only the registered tools (as listed). If a task requires an unregistered action, `write_file` a plan describing the required human step and open an issue for human approval.
- **Path Safety:** Always use relative paths from repo root and prefer `stat_file`/`read_file` before writing.
- **Test First/Last:** Tests (`run_tests`) must be run and pass before `create_pr` or `ship` steps.
- **Read/Write Discipline:** `read_file` and `read_context` before making decisions; update `.singularity/PLAN.md` last.
- **Explicit Arguments:** When calling `start_task`, `start_service`, or `create_pr`, always include the minimal args (e.g., `issue_id`, `command`, `title`).

## üé® Storybook Integration

### Official Storybook MCP Addon
This project uses the **official @storybook/addon-mcp** which runs as part of the Storybook dev server.

**Installation:**
```bash
# Install the addon
npx storybook add @storybook/addon-mcp
```

**Configuration in `.storybook/main.js`:**
```javascript
export default {
  addons: [
    {
      name: '@storybook/addon-mcp',
      options: {
        toolsets: {
          dev: true,  // Tools for story URL retrieval and UI building instructions
          docs: true  // Tools for component manifest and documentation
        },
        experimentalFormat: 'markdown'  // Output format: 'markdown' (default) or 'xml'
      }
    }
  ],
  features: {
    experimentalComponentsManifest: true  // Enable manifest generation for docs toolset
  }
};
```

### Storybook MCP Tools Available

The Storybook MCP server exposes these tools via HTTP at `http://localhost:6006/mcp`:

1. **get-ui-development-instructions**
   - Provides standardized instructions for UI component development
   - Returns guidelines for component structure, story creation, and best practices
   - **Usage:** ALWAYS call this before starting any UI/frontend/React development

2. **get-story-urls**
   - Retrieves direct URLs to specific stories in Storybook
   - Arguments: `absoluteStoryPath` (path to story file), `storyName` (optional)
   - Returns: URLs like `http://localhost:6006/?path=/story/example-button--primary`

3. **list-all-components** (when docs toolset enabled)
   - Lists all available components with metadata
   - Returns component names, descriptions, props, and story information

4. **get-component-documentation** (when docs toolset enabled)
   - Fetches detailed documentation for specific components
   - Includes prop types, examples, and usage guidelines

### Storybook Development Workflow

1. **Start Storybook with MCP:**
   ```bash
   npm run storybook
   # Storybook dev server runs on http://localhost:6006
   # MCP endpoint available at http://localhost:6006/mcp
   ```

2. **Before UI Development:**
   - ALWAYS call `get-ui-development-instructions` to understand project conventions
   - Use `list-all-components` to discover existing components
   - Check `get-component-documentation` to understand component APIs

3. **During Development:**
   - Create component implementation
   - Create corresponding `.stories.tsx` file with comprehensive examples
   - Use `get-story-urls` to get direct links for visual verification
   - Write tests that reference story examples

4. **Component Story Structure:**
   ```typescript
   // ComponentName.stories.tsx
   import type { Meta, StoryObj } from '@storybook/react';
   import { ComponentName } from './ComponentName';

   const meta: Meta<typeof ComponentName> = {
     title: 'Category/ComponentName',
     component: ComponentName,
     parameters: {
       layout: 'centered',
     },
     tags: ['autodocs'],
   };

   export default meta;
   type Story = StoryObj<typeof ComponentName>;

   export const Default: Story = {
     args: {
       // default props
     },
   };

   export const Variant: Story = {
     args: {
       // variant props
     },
   };
   ```

5. **Visual Verification:**
   - Use `get-story-urls` to retrieve URLs for each story
   - Open URLs in browser to verify visual implementation
   - Ensure all key states/variants are represented as stories

### MCP Connection in VSCode

The MCP configuration in `.vscode/mcp.json` (or global VSCode settings) should use HTTP transport:

```json
{
  "servers": {
    "storybook-addon-mcp": {
      "type": "http",
      "url": "http://localhost:6006/mcp",
      "transport": "streamable-http"
    }
  }
}
```

**Important Notes:**
- Storybook MUST be running (`npm run storybook`) for MCP tools to work
- The addon only supports Vite-based Storybook setups (react-vite, nextjs-vite, sveltekit)
- Requires Storybook version 9.1.16 or higher
- Agent should verify MCP connection before attempting UI development

## üîß Agent Developer Notes (mapping to code & server)

This manifest is protocol- and tool-centric. It is not bound to a specific server name. All CI gating and merge/ship decisions must use the `mcp_singularity-c_check_pipeline` tool as the final authority.

### Server & CLI
- **Start the MCP server (JSON-RPC over stdio):**
  - `node mcp/index.js`
  - It exposes the tools listed above to connected clients (JSON-RPC v2 over stdio).
- **Storybook MCP integration:**
  - The Storybook MCP addon runs as part of your Storybook dev server
  - Exposes HTTP endpoint at `http://localhost:6006/mcp`
  - Provides component discovery and UI development guidance tools
  - **CRITICAL:** Storybook must be running for MCP tools to work
  - Start with: `npm run storybook` (or `pnpm storybook`)
  
- **List available tools (human-friendly):**
  - `node mcp/list-tools.js` ‚Äî spawns the server and prints the registered tool schemas.
- **Launch the UI (optional):**
  - `bin/nexus` (runs `npm run dev --prefix ui`).

### Implementation mapping
- File operations: `mcp/tools/files.js` ‚Üí exports: `readFile`, `writeFile`, `statFile`, `searchCode`, `exploreTree` (mapped to `read_file`, `write_file`, `stat_file`, `search_code`, `explore_file_tree`).
- Git & issue operations: `mcp/tools/git.js` ‚Üí exports: `createIssue`, `updateIssue`, `startTask`, `createPR`, `getDiff`, `checkPipeline` (mapped to `create_issue`, `update_issue`, `start_task`, `create_pr`, `get_git_diff`, `check_pipeline`).
- Service/test helpers: `mcp/tools/ops.js` ‚Üí `startService`, `runTests` (mapped to `start_service`, `run_tests`).

**Note:** Tests and agent integrations should use `MCP_REPO_OVERRIDE` to point the server at a temp repository path for deterministic behavior.


## üìö Troubleshooting & Debugging
- If `read_file` returns `Access Denied`, use `stat_file` then `debugPath` (if available) and check `.singularity/PLAN.md` for context.
- For flakiness in tests or file path issues, prefer using `MCP_REPO_OVERRIDE` in tests to point to isolated temp directories.
- **Storybook MCP Not Responding:** Ensure Storybook dev server is running on port 6006 before attempting to use MCP tools.
- **Component Discovery Issues:** Verify `experimentalComponentsManifest: true` is enabled in Storybook features.

## üß≠ Behavioral Constraints
- Be concise and conservative with diffs: small incremental changes are preferred.
- If a step requires elevated rights (e.g., modifying CI workflows), open an issue and include a plan in `.singularity/PLAN.md` rather than applying directly.
- **UI Development Protocol:** ALWAYS call `get-ui-development-instructions` before starting any frontend/React/component work to understand project conventions.
- **Component Reuse:** Use `list-all-components` to discover existing components before creating new ones.

---

*This agent manifest is intended to be a single source of in-repo instructions for automated agents that use the MCP tooling. Keep it synced with `mcp/tools/*` implementations.*